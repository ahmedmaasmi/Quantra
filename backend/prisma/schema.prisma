// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(cuid())
  name           String
  email          String        @unique
  password       String
  kycStatus      String        @default("pending")
  phone          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  transactions   Transaction[]
  alerts         Alert[]
  cases          Case[]
}

model Transaction {
  id             String    @id @default(cuid())
  userId         String
  amount         Float
  merchant       String?
  category       String?
  country        String?
  type           String?   // "credit" | "debit"
  description    String?
  fraudScore     Float?    @default(0)
  isFlagged      Boolean   @default(false)
  explanation    String?
  location       String?
  metadata       Json?
  timestamp      DateTime  @default(now())
  createdAt      DateTime  @default(now())
  
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  alerts         Alert[]
  
  @@index([userId])
  @@index([createdAt])
  @@index([timestamp])
}

model Alert {
  id             String       @id @default(cuid())
  userId         String
  transactionId  String?
  type           String       // "fraud" | "unusual" | "limit" | "kyc"
  message        String
  severity       String       @default("medium") // "low" | "medium" | "high"
  status         String       @default("open") // "open" | "resolved" | "closed"
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction    Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  cases          Case[]
  
  @@index([userId])
  @@index([isRead])
  @@index([status])
}

model Forecast {
  id          String   @id @default(cuid())
  userId      String?
  prediction  Json
  model       String
  accuracy    Float?
  createdAt   DateTime @default(now())
  
  @@index([userId])
}

model Case {
  id             String   @id @default(cuid())
  userId         String
  alertId        String
  summary        String
  status         String   @default("open") // "open" | "assigned" | "resolved" | "closed"
  assignedTo     String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  alert          Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([alertId])
  @@index([status])
}

model Simulation {
  id          String      @id @default(cuid())
  name        String
  status      String      @default("pending") // "pending" | "running" | "completed" | "failed"
  inputData   Json
  outputData  Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  metrics     AiMetric[]
  
  @@index([status])
  @@index([createdAt])
}

model AiMetric {
  id            String      @id @default(cuid())
  simulationId  String
  accuracy      Float
  loss          Float
  duration      Float       // in seconds
  timestamp     DateTime    @default(now())
  
  simulation    Simulation  @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  
  @@index([simulationId])
  @@index([timestamp])
}
